{% extends 'council_app/base.html' %}

{% block title %}{{ section.section_title }} - Report Section{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <a href="{% url 'council_app:report_detail' pk=project.id %}" class="text-teal-600 hover:text-teal-700 text-sm flex items-center">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Back to Report Dashboard
        </a>
        <div class="flex items-center justify-between mt-2">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">{{ section.section_title }}</h1>
                <p class="text-gray-600 mt-1">
                    Section {{ section.order }} of {{ outline.sections.count }} in <strong>{{ project.title }}</strong>
                </p>
            </div>
            
            <!-- Status Badge -->
            <span class="px-3 py-1.5 text-sm font-medium rounded-full
                         {% if section.status == 'approved' %}bg-green-100 text-green-700
                         {% elif section.status == 'review' %}bg-yellow-100 text-yellow-700
                         {% elif section.status == 'in_progress' %}bg-blue-100 text-blue-700
                         {% elif section.status == 'needs_revision' %}bg-orange-100 text-orange-700
                         {% else %}bg-gray-100 text-gray-600{% endif %}">
                {{ section.get_status_display }}
            </span>
        </div>
    </div>
    
    <!-- Status Polling (for in_progress) -->
    {% if section.status == 'in_progress' %}
    <div id="section-status-poll"
         hx-get="{% url 'council_app:section_status' pk=section.id %}"
         hx-trigger="every 3s"
         hx-swap="innerHTML">
        {% include 'council_app/churn/partials/section_status.html' %}
    </div>
    {% endif %}
    
    <!-- Stats Row -->
    {% if section.compliance_percent is not None or section.iteration_count > 0 %}
    <div class="grid grid-cols-3 gap-4 mb-6">
        {% if section.compliance_percent is not None %}
        <div class="bg-white rounded-lg shadow-sm p-4 text-center">
            <span class="block text-3xl font-bold 
                         {% if section.compliance_score >= 0.7 %}text-green-600
                         {% elif section.compliance_score >= 0.4 %}text-yellow-600
                         {% else %}text-red-600{% endif %}">
                {{ section.compliance_percent }}%
            </span>
            <span class="text-sm text-gray-500">Compliance Score</span>
        </div>
        {% endif %}
        
        <div class="bg-white rounded-lg shadow-sm p-4 text-center">
            <span class="block text-3xl font-bold text-gray-700">{{ section.iteration_count }}</span>
            <span class="text-sm text-gray-500">Review Iteration{{ section.iteration_count|pluralize }}</span>
        </div>
        
        {% if processing_time %}
        <div class="bg-white rounded-lg shadow-sm p-4 text-center">
            <span class="block text-3xl font-bold text-gray-700">{{ processing_time|floatformat:1 }}s</span>
            <span class="text-sm text-gray-500">Processing Time</span>
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Error Message -->
    {% if section.error_message %}
    <div class="mb-6 p-4 bg-red-50 rounded-lg border border-red-200">
        <p class="font-medium text-red-800">Error</p>
        <p class="text-sm text-red-600 mt-1">{{ section.error_message }}</p>
    </div>
    {% endif %}
    
    <!-- Content Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Original Content -->
        <div class="bg-white rounded-lg shadow-sm">
            <div class="p-4 border-b border-gray-200">
                <h2 class="font-semibold text-gray-900">Original Content</h2>
            </div>
            <div class="p-4">
                {% if section.original_content %}
                <div class="prose prose-sm max-w-none whitespace-pre-wrap font-mono text-sm text-gray-700 bg-gray-50 p-4 rounded-lg">{{ section.original_content }}</div>
                {% else %}
                <p class="text-gray-400 italic">No initial content provided</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Current/Revised Content -->
        <div class="bg-white rounded-lg shadow-sm">
            <div class="p-4 border-b border-gray-200">
                <h2 class="font-semibold text-gray-900">
                    {% if section.status == 'review' or section.status == 'approved' %}Revised Content{% else %}Current Content{% endif %}
                </h2>
            </div>
            <div class="p-4">
                {% if section.current_content %}
                <div class="prose prose-sm max-w-none whitespace-pre-wrap font-mono text-sm text-gray-700 bg-gray-50 p-4 rounded-lg">{{ section.current_content }}</div>
                {% else %}
                <p class="text-gray-400 italic">Not yet processed</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Diff View -->
    {% if diff_lines %}
    <div class="bg-white rounded-lg shadow-sm mb-6">
        <div class="p-4 border-b border-gray-200">
            <h2 class="font-semibold text-gray-900">Changes</h2>
        </div>
        <div class="p-4 font-mono text-sm overflow-x-auto">
            {% for line in diff_lines %}
            <div class="{% if line.type == 'addition' %}bg-green-50 text-green-800{% elif line.type == 'deletion' %}bg-red-50 text-red-800{% elif line.type == 'hunk' %}bg-blue-50 text-blue-700{% elif line.type == 'header' %}text-gray-400{% else %}text-gray-600{% endif %} px-3 py-0.5">
                {% if line.type == 'addition' %}+{% elif line.type == 'deletion' %}-{% elif line.type == 'context' %} {% endif %}{{ line.content }}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Council Feedback -->
    {% if synthesized_feedback %}
    <div class="bg-white rounded-lg shadow-sm mb-6">
        <div class="p-4 border-b border-gray-200">
            <h2 class="font-semibold text-gray-900">Council Feedback</h2>
        </div>
        <div class="p-4">
            <div class="prose prose-sm max-w-none whitespace-pre-wrap text-gray-700">{{ synthesized_feedback }}</div>
        </div>
    </div>
    {% endif %}
    
    <!-- Raw Responses (collapsible) -->
    {% if section.raw_responses %}
    <details class="bg-white rounded-lg shadow-sm mb-6">
        <summary class="p-4 cursor-pointer font-semibold text-gray-900 hover:bg-gray-50 rounded-t-lg">
            Individual Model Responses ({{ section.raw_responses|length }})
        </summary>
        <div class="p-4 border-t border-gray-200 space-y-4">
            {% for resp in section.raw_responses %}
            <div class="border border-gray-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="font-medium text-gray-900">{{ resp.model }}</span>
                    <span class="text-sm text-gray-500">{{ resp.response_time|floatformat:1 }}s</span>
                </div>
                <div class="whitespace-pre-wrap text-sm text-gray-600 max-h-64 overflow-y-auto">{{ resp.response|truncatechars:2000 }}</div>
            </div>
            {% endfor %}
        </div>
    </details>
    {% endif %}
    
    <!-- Actions -->
    {% if section.status == 'review' %}
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <h2 class="font-semibold text-gray-900 mb-4">Review Actions</h2>
        <form method="post" action="{% url 'council_app:section_approve' pk=section.id %}">
            {% csrf_token %}
            
            <div class="space-y-4">
                <!-- Action Selection -->
                <div class="grid grid-cols-3 gap-3">
                    <label class="relative flex cursor-pointer rounded-lg border bg-white p-4 shadow-sm focus:outline-none hover:bg-gray-50">
                        <input type="radio" name="action" value="approve" class="sr-only" checked>
                        <span class="flex flex-1 flex-col">
                            <span class="block text-sm font-medium text-gray-900">Approve</span>
                            <span class="mt-1 text-xs text-gray-500">Accept revised content</span>
                        </span>
                        <svg class="h-5 w-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                    </label>
                    
                    <label class="relative flex cursor-pointer rounded-lg border bg-white p-4 shadow-sm focus:outline-none hover:bg-gray-50">
                        <input type="radio" name="action" value="revise" class="sr-only">
                        <span class="flex flex-1 flex-col">
                            <span class="block text-sm font-medium text-gray-900">Request Revision</span>
                            <span class="mt-1 text-xs text-gray-500">Send back for another round</span>
                        </span>
                        <svg class="h-5 w-5 text-orange-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path>
                        </svg>
                    </label>
                    
                    <label class="relative flex cursor-pointer rounded-lg border bg-white p-4 shadow-sm focus:outline-none hover:bg-gray-50">
                        <input type="radio" name="action" value="edit" class="sr-only" id="edit-radio">
                        <span class="flex flex-1 flex-col">
                            <span class="block text-sm font-medium text-gray-900">Edit Manually</span>
                            <span class="mt-1 text-xs text-gray-500">Modify content yourself</span>
                        </span>
                        <svg class="h-5 w-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                        </svg>
                    </label>
                </div>
                
                <!-- Edit Content (shown when Edit Manually is selected) -->
                <div id="edit-content-area" class="hidden">
                    <label for="id_edited_content" class="block text-sm font-medium text-gray-700 mb-1">
                        Edited Content
                    </label>
                    <textarea name="edited_content" id="id_edited_content" rows="15"
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-mono text-sm">{{ section.current_content }}</textarea>
                </div>
                
                <button type="submit" 
                        class="w-full px-4 py-3 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors font-medium">
                    Submit Review
                </button>
            </div>
        </form>
    </div>
    {% endif %}
    
    <!-- Trigger new review -->
    {% if section.status in 'pending,needs_revision,approved' %}
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <h2 class="font-semibold text-gray-900 mb-4">
            {% if section.status == 'approved' %}Re-review Section{% else %}Start Review{% endif %}
        </h2>
        <form method="post" action="{% url 'council_app:section_churn' pk=section.id %}" class="flex items-center space-x-4">
            {% csrf_token %}
            
            <div class="flex-1 flex items-center space-x-2">
                {% for model in models %}
                <label class="flex items-center text-sm">
                    <input type="checkbox" name="models" value="{{ model.id }}"
                           {% if model.id in default_model_ids %}checked{% endif %}
                           class="h-4 w-4 text-teal-600 border-gray-300 rounded mr-1">
                    {{ model.display_name|default:model.name }}
                </label>
                {% endfor %}
            </div>
            
            <button type="submit" 
                    class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors font-medium text-sm">
                {% if section.iteration_count > 0 %}Re-review{% else %}Start Review{% endif %}
            </button>
        </form>
    </div>
    {% endif %}
    
    <!-- Section Navigation -->
    <div class="flex items-center justify-between mt-6">
        {% if prev_section %}
        <a href="{% url 'council_app:section_detail' pk=prev_section.id %}" 
           class="flex items-center text-sm text-teal-600 hover:text-teal-700">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            {{ prev_section.section_title|truncatechars:30 }}
        </a>
        {% else %}
        <div></div>
        {% endif %}
        
        {% if next_section %}
        <a href="{% url 'council_app:section_detail' pk=next_section.id %}" 
           class="flex items-center text-sm text-teal-600 hover:text-teal-700">
            {{ next_section.section_title|truncatechars:30 }}
            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </a>
        {% else %}
        <div></div>
        {% endif %}
    </div>
</div>

{% block extra_js %}
<script>
    // Toggle edit content area based on radio selection
    document.querySelectorAll('input[name="action"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const editArea = document.getElementById('edit-content-area');
            if (this.value === 'edit') {
                editArea.classList.remove('hidden');
            } else {
                editArea.classList.add('hidden');
            }
        });
    });
</script>
{% endblock %}
{% endblock %}
